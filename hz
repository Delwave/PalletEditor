import tkinter as tk
from tkinter import ttk, messagebox
from docx import Document
from docx.shared import Inches, Mm
from docx.enum.section import WD_ORIENT
from barcode import Code128
from barcode.writer import ImageWriter
import os
import tempfile
import subprocess
from pathlib import Path
import shutil

class PalletLabelEditor:
    def __init__(self, root):
        self.root = root
        self.root.title("–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞–ª–ª–µ—Ç–Ω—ã—Ö —ç—Ç–∏–∫–µ—Ç–æ–∫")
        self.root.geometry("450x550")
        
        self.desktop_path = Path.home() / "Desktop"
        self.template_path = self.create_template()
        
        self.create_widgets()
    
    def create_template(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ—á–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ —Å –∞–ª—å–±–æ–º–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–µ–π"""
        template_dir = Path(__file__).parent / "templates"
        template_dir.mkdir(exist_ok=True)
        
        template_path = template_dir / "pallet_template.docx"
        
        # –°–æ–∑–¥–∞–µ–º —à–∞–±–ª–æ–Ω —Å –∞–ª—å–±–æ–º–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–µ–π A5
        doc = Document()
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–ª—å–±–æ–º–Ω—É—é –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é A5
        section = doc.sections[0]
        section.page_height = Mm(148)  # A5 width -> height in portrait
        section.page_width = Mm(210)   # A5 height -> width in portrait
        section.orientation = WD_ORIENT.LANDSCAPE
        section.top_margin = Mm(10)
        section.bottom_margin = Mm(10)
        section.left_margin = Mm(10)
        section.right_margin = Mm(10)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞
        doc.add_paragraph("–ó–¥–µ—Å—å –±—É–¥–µ—Ç —à—Ç—Ä–∏—Ö-–∫–æ–¥")
        
        # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
        doc.add_paragraph()
        
        # –ù–æ–º–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ –∂–∏—Ä–Ω—ã–º
        p = doc.add_paragraph()
        p.add_run("01000000049721025000186840").bold = True
        
        # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
        doc.add_paragraph()
        
        # –ö–æ–¥ –∏ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
        doc.add_paragraph("–ö–æ–¥ –∏ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞:")
        
        # –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∂–∏—Ä–Ω—ã–º
        p = doc.add_paragraph()
        p.add_run('–í–∏—Å–∫–∏ "William Lawson\'s ", 0,5 –ª., 40%').bold = True
        
        # –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å
        doc.add_paragraph("–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å: –û–û–û ¬´–ó–∞–≤–æ–¥ –ì–µ–æ—Ä–≥–∏–µ–≤—Å–∫–∏–π. –¢—Ä–∞–¥–∏—Ü–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞¬ª.")
        
        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–æ–±–æ–≤
        doc.add_paragraph("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–æ–±–æ–≤: ")
        p = doc.paragraphs[-1]
        p.add_run("65").bold = True
        
        # –î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–ª–ª–µ—Ç—ã
        doc.add_paragraph("–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–ª–ª–µ—Ç—ã: ")
        p = doc.paragraphs[-1]
        p.add_run("25.09.2025").bold = True
        
        # –°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏
        doc.add_paragraph("–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏: ")
        p = doc.paragraphs[-1]
        p.add_run("–Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω").bold = True
        
        doc.save(template_path)
        return template_path
    
    def create_widgets(self):
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        title_label = ttk.Label(self.root, text="–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞–ª–ª–µ—Ç–Ω—ã—Ö —ç—Ç–∏–∫–µ—Ç–æ–∫", 
                               font=("Arial", 12, "bold"))
        title_label.pack(pady=10)
        
        # –ü–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö
        fields = [
            ("–®—Ç—Ä–∏—Ö-–∫–æ–¥ (Code-128):", "barcode_entry", "01000000049721025000186840"),
            ("–ö–æ–¥ –∏ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞:", "product_entry", '–í–∏—Å–∫–∏ "William Lawson\'s ", 0,5 –ª., 40%'),
            ("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–æ–±–æ–≤:", "quantity_entry", "65"),
            ("–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–ª–ª–µ—Ç—ã:", "date_entry", "25.09.2025"),
            ("–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏:", "expiry_entry", "–Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω")
        ]
        
        for label_text, attr_name, default_value in fields:
            ttk.Label(self.root, text=label_text, font=("Arial", 9)).pack(pady=3)
            entry = ttk.Entry(self.root, width=50, font=("Arial", 9))
            entry.pack(pady=2)
            entry.insert(0, default_value)
            setattr(self, attr_name, entry)
        
        # –§—Ä–µ–π–º –¥–ª—è –∫–Ω–æ–ø–æ–∫
        button_frame = ttk.Frame(self.root)
        button_frame.pack(pady=20)
        
        # –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è
        create_btn = ttk.Button(button_frame, text="üñ®Ô∏è –°–æ–∑–¥–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫—É", 
                               command=self.create_label, width=25)
        create_btn.pack(pady=10)
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        info_label = ttk.Label(self.root, 
                              text="–§–æ—Ä–º–∞—Ç: A5 –∞–ª—å–±–æ–º–Ω—ã–π\n–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª",
                              font=("Arial", 8), foreground="gray", justify='center')
        info_label.pack(pady=5)
    
    def generate_barcode(self, code):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è A5"""
        temp_dir = tempfile.gettempdir()
        barcode_path = os.path.join(temp_dir, f'temp_barcode_{code}')
        
        writer = ImageWriter()
        writer.options = {
            'module_width': 0.15,      # –£–∂–µ –ª–∏–Ω–∏–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
            'module_height': 10.0,     # –ù–∏–∂–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥
            'quiet_zone': 2.0,         # –ú–µ–Ω—å—à–µ –æ—Ç—Å—Ç—É–ø—ã
            'font_size': 7,            # –ú–µ–Ω—å—à–µ —à—Ä–∏—Ñ—Ç —Ü–∏—Ñ—Ä
            'text_distance': 1.5,      # –ú–µ–Ω—å—à–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–∏—Ñ—Ä
            'write_text': True,        # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ü–∏—Ñ—Ä—ã
            'text': ''                 # –ü—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã —Ü–∏—Ñ—Ä—ã –±—ã–ª–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É
        }
        
        barcode = Code128(code, writer=writer)
        filename = barcode.save(barcode_path)
        return filename
    
    def replace_text_in_document(self, doc, old_text, new_text):
        """–ó–∞–º–µ–Ω–∞ —Ç–µ–∫—Å—Ç–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
        replaced = False
        
        # –ò—â–µ–º –≤ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞—Ö
        for paragraph in doc.paragraphs:
            if old_text in paragraph.text:
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ runs
                for run in paragraph.runs:
                    if old_text in run.text:
                        run.text = run.text.replace(old_text, new_text)
                        replaced = True
                        print(f"–ó–∞–º–µ–Ω–µ–Ω –≤ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–µ: '{old_text}' -> '{new_text}'")
        
        # –ò—â–µ–º –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö
        for table in doc.tables:
            for row in table.rows:
                for cell in row.cells:
                    if old_text in cell.text:
                        for paragraph in cell.paragraphs:
                            for run in paragraph.runs:
                                if old_text in run.text:
                                    run.text = run.text.replace(old_text, new_text)
                                    replaced = True
                                    print(f"–ó–∞–º–µ–Ω–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ: '{old_text}' -> '{new_text}'")
        
        return replaced
    
    def replace_specific_elements(self, doc):
        """–ó–∞–º–µ–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ –∏—Ö –ø–æ–∑–∏—Ü–∏–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ"""
        try:
            replacements = [
                (2, 0, self.barcode_entry.get().strip()),  # –ù–æ–º–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ (3–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ, 1–π run)
                (5, 0, self.product_entry.get().strip()),  # –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ (6–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ, 1–π run)
                (7, 1, self.quantity_entry.get().strip()), # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–æ–±–æ–≤ (8–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ, 2–π run)
                (8, 1, self.date_entry.get().strip()),     # –î–∞—Ç–∞ (9–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ, 2–π run)
                (9, 1, self.expiry_entry.get().strip())    # –°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ (10–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ, 2–π run)
            ]
            
            replaced_count = 0
            for para_idx, run_idx, new_text in replacements:
                if para_idx < len(doc.paragraphs):
                    paragraph = doc.paragraphs[para_idx]
                    if run_idx < len(paragraph.runs):
                        paragraph.runs[run_idx].text = new_text
                        replaced_count += 1
                        print(f"–ó–∞–º–µ–Ω–µ–Ω —ç–ª–µ–º–µ–Ω—Ç [{para_idx},{run_idx}]: '{new_text}'")
            
            return replaced_count
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –≤ –∑–∞–º–µ–Ω–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: {e}")
            return 0
    
    def replace_barcode_image(self, doc, new_barcode_path):
        """–ó–∞–º–µ–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –¥–ª—è A5"""
        try:
            # –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ (–≥–¥–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —à—Ç—Ä–∏—Ö-–∫–æ–¥)
            if len(doc.paragraphs) > 0:
                first_paragraph = doc.paragraphs[0]
                
                # –û—á–∏—â–∞–µ–º –ø–∞—Ä–∞–≥—Ä–∞—Ñ –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
                for run in first_paragraph.runs:
                    run.text = ""
                
                # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —à—Ç—Ä–∏—Ö-–∫–æ–¥ —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º –¥–ª—è A5 –∞–ª—å–±–æ–º–Ω–æ–≥–æ
                run = first_paragraph.add_run()
                # –®–∏—Ä–∏–Ω–∞ A5 –∞–ª—å–±–æ–º–Ω–æ–≥–æ: 210mm, –≤—ã—á–∏—Ç–∞–µ–º –ø–æ–ª—è 10mm*2 = 190mm –¥–æ—Å—Ç—É–ø–Ω–æ
                run.add_picture(new_barcode_path, width=Mm(160))  # –û—Å—Ç–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã
                return True
            return False
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–º–µ–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
            return False
    
    def create_label(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —ç—Ç–∏–∫–µ—Ç–∫–∏"""
        try:
            if not os.path.exists(self.template_path):
                messagebox.showerror("–û—à–∏–±–∫–∞", "–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!")
                return
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            barcode_text = self.barcode_entry.get().strip()
            if not barcode_text:
                messagebox.showerror("–û—à–∏–±–∫–∞", "–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥!")
                return
            
            # –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é —à–∞–±–ª–æ–Ω–∞
            temp_dir = tempfile.gettempdir()
            temp_doc_path = os.path.join(temp_dir, f"temp_pallet_{barcode_text}.docx")
            shutil.copy2(self.template_path, temp_doc_path)
            
            # –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–æ–ø–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            doc = Document(temp_doc_path)
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —à—Ç—Ä–∏—Ö-–∫–æ–¥ —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
            barcode_filename = self.generate_barcode(barcode_text)
            
            # –ó–∞–º–µ–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –ø–æ–∑–∏—Ü–∏—è–º (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π –º–µ—Ç–æ–¥)
            replaced_count = self.replace_specific_elements(doc)
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–µ–∫—Å—Ç–æ–≤–∞—è –∑–∞–º–µ–Ω–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            text_replacements = {
                "01000000049721025000186840": barcode_text,
                '–í–∏—Å–∫–∏ "William Lawson\'s ", 0,5 –ª., 40%': self.product_entry.get().strip(),
                "65": self.quantity_entry.get().strip(),
                "25.09.2025": self.date_entry.get().strip(),
                "–Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω": self.expiry_entry.get().strip()
            }
            
            for old_text, new_text in text_replacements.items():
                if self.replace_text_in_document(doc, old_text, new_text):
                    replaced_count += 1
            
            # –ó–∞–º–µ–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞
            image_replaced = self.replace_barcode_image(doc, barcode_filename)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª
            final_filename = self.desktop_path / f"–ü–∞–ª–ª–µ—Ç–Ω–∞—è_—ç—Ç–∏–∫–µ—Ç–∫–∞_{barcode_text}.docx"
            doc.save(final_filename)
            
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
            if os.path.exists(barcode_filename):
                os.remove(barcode_filename)
            if os.path.exists(temp_doc_path):
                os.remove(temp_doc_path)
            
            # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
            self.open_document(final_filename)
            
            messagebox.showinfo("–ì–æ—Ç–æ–≤–æ!", 
                              f"–≠—Ç–∏–∫–µ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!\n\n"
                              f"–§–∞–π–ª: {final_filename.name}\n"
                              f"–§–æ—Ä–º–∞—Ç: A5 –∞–ª—å–±–æ–º–Ω—ã–π\n"
                              f"–ó–∞–º–µ–Ω–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: {replaced_count}\n"
                              f"–®—Ç—Ä–∏—Ö-–∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω: {'–î–∞' if image_replaced else '–ù–µ—Ç'}")
            
        except Exception as e:
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç—Ç–∏–∫–µ—Ç–∫–∏:\n{str(e)}")
    
    def open_document(self, file_path):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
        try:
            if os.path.exists(file_path):
                if os.name == 'nt':  # Windows
                    os.startfile(file_path)
                elif os.name == 'posix':  # macOS, Linux
                    subprocess.run(['open', file_path] if os.name == 'posix' and os.uname().sysname == 'Darwin' else ['xdg-open', file_path])
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–∞–π–ª–∞: {e}")

if __name__ == "__main__":
    root = tk.Tk()
    app = PalletLabelEditor(root)
    root.mainloop()