import tkinter as tk
from tkinter import ttk, messagebox, filedialog
from docx import Document
from docx.shared import Mm, Inches
from barcode import Code128
from barcode.writer import ImageWriter
import os
import tempfile
import subprocess

class PalletLabelEditor:
    def __init__(self, root):
        self.root = root
        self.root.title("Редактор паллетных этикеток")
        self.root.geometry("400x550")
        
        self.create_widgets()
    
    def create_widgets(self):
        # Поля для ввода данных
        ttk.Label(self.root, text="Штрих-код (Code-128):").pack(pady=5)
        self.barcode_entry = ttk.Entry(self.root, width=40)
        self.barcode_entry.pack(pady=5)
        self.barcode_entry.insert(0, "01000000049721025000186840")
        
        ttk.Label(self.root, text="Код и наименование продукта:").pack(pady=5)
        self.product_entry = ttk.Entry(self.root, width=40)
        self.product_entry.pack(pady=5)
        self.product_entry.insert(0, 'Виски "William Lawson\'s ", 0,5 л., 40%')
        
        ttk.Label(self.root, text="Количество коробов:").pack(pady=5)
        self.quantity_entry = ttk.Entry(self.root, width=40)
        self.quantity_entry.pack(pady=5)
        self.quantity_entry.insert(0, "65")
        
        ttk.Label(self.root, text="Дата закрытия паллеты:").pack(pady=5)
        self.date_entry = ttk.Entry(self.root, width=40)
        self.date_entry.pack(pady=5)
        self.date_entry.insert(0, "25.09.2025")
        
        ttk.Label(self.root, text="Срок годности:").pack(pady=5)
        self.expiry_entry = ttk.Entry(self.root, width=40)
        self.expiry_entry.pack(pady=5)
        self.expiry_entry.insert(0, "не ограничен")
        
        # Фрейм для кнопок
        button_frame = ttk.Frame(self.root)
        button_frame.pack(pady=20)
        
        # Кнопки
        ttk.Button(button_frame, text="Создать документ", 
                  command=self.create_document).pack(pady=5, fill='x')
        
        ttk.Button(button_frame, text="Сохранить как...", 
                  command=self.save_document).pack(pady=5, fill='x')
        
        ttk.Button(button_frame, text="Открыть для печати", 
                  command=self.open_for_print).pack(pady=5, fill='x')
    
    def generate_barcode(self, code):
        """Генерация штрих-кода"""
        temp_dir = tempfile.gettempdir()
        barcode_path = os.path.join(temp_dir, 'temp_barcode')
        
        # Настройки для лучшего отображения штрих-кода
        writer = ImageWriter()
        writer.options = {
            'module_width': 0.2,  # Толщина линий
            'module_height': 15.0,  # Высота штрих-кода
            'quiet_zone': 6.5,  # Отступы по бокам
            'font_size': 10,  # Размер шрифта под штрих-кодом
            'text_distance': 5.0  # Расстояние от штрих-кода до текста
        }
        
        barcode = Code128(code, writer=writer)
        filename = barcode.save(barcode_path)
        
        return filename
    
    def create_document(self):
        """Создание документа Word в точности как в шаблоне"""
        try:
            self.doc = Document()
            
            # Устанавливаем формат A5 с увеличенными полями для штрих-кода
            section = self.doc.sections[0]
            section.page_height = Mm(210)  # A5 высота
            section.page_width = Mm(148)   # A5 ширина
            section.top_margin = Mm(8)     # Уменьшенные поля
            section.bottom_margin = Mm(8)
            section.left_margin = Mm(8)
            section.right_margin = Mm(8)
            
            # Генерация штрих-кода
            barcode_filename = self.generate_barcode(self.barcode_entry.get())
            
            # Проверяем существование файла
            if not os.path.exists(barcode_filename):
                messagebox.showerror("Ошибка", f"Файл штрих-кода не найден: {barcode_filename}")
                return
            
            # Добавление штрих-кода в документ - подгоняем под ширину A5
            # Ширина A5 = 148mm, вычитаем поля 8mm*2 = 132mm доступной ширины
            self.doc.add_picture(barcode_filename, width=Mm(130))  # Оставляем небольшие отступы
            
            # Пустая строка для разделения
            self.doc.add_paragraph()
            
            # Номер штрих-кода жирным - ТОЧНО КАК В ВАШЕМ ФАЙЛЕ
            p = self.doc.add_paragraph()
            p.alignment = 1  # Выравнивание по центру
            p_run = p.add_run(self.barcode_entry.get())
            p_run.bold = True
            p_run.font.size = Mm(3.5)
            
            # Пустая строка
            self.doc.add_paragraph()
            
            # Код и наименование продукта
            p = self.doc.add_paragraph()
            p_run = p.add_run("Код и наименование продукта:")
            p_run.font.size = Mm(3)
            
            p = self.doc.add_paragraph()
            p_run = p.add_run(self.product_entry.get())
            p_run.bold = True
            p_run.font.size = Mm(3)
            
            # Производитель
            p = self.doc.add_paragraph()
            p_run = p.add_run("Производитель: ООО «Завод Георгиевский. Традиции качества».")
            p_run.font.size = Mm(3)
            
            # Количество коробов
            p = self.doc.add_paragraph()
            p_run = p.add_run("Количество коробов:")
            p_run.font.size = Mm(3)
            
            p = self.doc.add_paragraph()
            p_run = p.add_run(self.quantity_entry.get())
            p_run.bold = True
            p_run.font.size = Mm(3)
            
            # Дата закрытия паллеты
            p = self.doc.add_paragraph()
            p_run = p.add_run("Дата закрытия паллеты:")
            p_run.font.size = Mm(3)
            
            p = self.doc.add_paragraph()
            p_run = p.add_run(self.date_entry.get())
            p_run.bold = True
            p_run.font.size = Mm(3)
            
            # Срок годности
            p = self.doc.add_paragraph()
            p_run = p.add_run("Срок годности:")
            p_run.font.size = Mm(3)
            
            p = self.doc.add_paragraph()
            p_run = p.add_run(self.expiry_entry.get())
            p_run.bold = True
            p_run.font.size = Mm(3)
            
            # Автосохранение в текущую директорию
            filename = f"паллетная_этикетка_{self.barcode_entry.get()}.docx"
            self.doc.save(filename)
            
            # Удаление временного файла штрих-кода
            if os.path.exists(barcode_filename):
                os.remove(barcode_filename)
            
            self.current_file = filename
            messagebox.showinfo("Успех", f"Документ создан и сохранен как: {filename}")
            
        except Exception as e:
            messagebox.showerror("Ошибка", f"Ошибка при создании документа: {str(e)}")
    
    def save_document(self):
        """Сохранение документа с выбором пути"""
        try:
            if not hasattr(self, 'doc'):
                messagebox.showwarning("Предупреждение", "Сначала создайте документ")
                return
            
            # Диалог выбора пути сохранения
            filename = filedialog.asksaveasfilename(
                defaultextension=".docx",
                filetypes=[
                    ("Word documents", "*.docx"),
                    ("All files", "*.*")
                ],
                title="Сохранить документ как..."
            )
            
            if filename:
                self.doc.save(filename)
                self.current_file = filename
                messagebox.showinfo("Успех", f"Документ сохранен как: {filename}")
                
        except Exception as e:
            messagebox.showerror("Ошибка", f"Ошибка при сохранении: {str(e)}")
    
    def open_for_print(self):
        """Открытие документа для ручной печати"""
        try:
            if hasattr(self, 'current_file') and os.path.exists(self.current_file):
                # Открываем файл в ассоциированной программе
                if os.name == 'nt':  # Windows
                    os.startfile(self.current_file)
                elif os.name == 'posix':  # macOS, Linux
                    subprocess.run(['open', self.current_file] if os.name == 'posix' and os.uname().sysname == 'Darwin' else ['xdg-open', self.current_file])
                
                messagebox.showinfo("Открытие", 
                                  "Документ открыт в программе по умолчанию.\n"
                                  "Формат страницы уже установлен в A5.")
            else:
                messagebox.showwarning("Предупреждение", 
                                     "Сначала создайте и сохраните документ")
                
        except Exception as e:
            messagebox.showerror("Ошибка", f"Ошибка при открытии файла: {str(e)}")

if __name__ == "__main__":
    root = tk.Tk()
    app = PalletLabelEditor(root)
    root.mainloop()