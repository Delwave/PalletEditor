import tkinter as tk
from tkinter import ttk, messagebox, filedialog
from docx import Document
from docx.shared import Inches
from barcode import Code128
from barcode.writer import ImageWriter
import os
import tempfile
import subprocess
from pathlib import Path
import shutil

class PalletLabelEditor:
    def __init__(self, root):
        self.root = root
        self.root.title("–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞–ª–ª–µ—Ç–Ω—ã—Ö —ç—Ç–∏–∫–µ—Ç–æ–∫")
        self.root.geometry("400x500")
        
        self.template_path = ""
        self.desktop_path = Path.home() / "Desktop"
        
        self.create_widgets()
    
    def create_widgets(self):
        # –ü–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö
        ttk.Label(self.root, text="–®—Ç—Ä–∏—Ö-–∫–æ–¥ (Code-128):", font=("Arial", 10)).pack(pady=8)
        self.barcode_entry = ttk.Entry(self.root, width=40, font=("Arial", 10))
        self.barcode_entry.pack(pady=5)
        self.barcode_entry.insert(0, "01000000049721025000186840")
        
        ttk.Label(self.root, text="–ö–æ–¥ –∏ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞:", font=("Arial", 10)).pack(pady=8)
        self.product_entry = ttk.Entry(self.root, width=40, font=("Arial", 10))
        self.product_entry.pack(pady=5)
        self.product_entry.insert(0, '–í–∏—Å–∫–∏ "William Lawson\'s ", 0,5 –ª., 40%')
        
        ttk.Label(self.root, text="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–æ–±–æ–≤:", font=("Arial", 10)).pack(pady=8)
        self.quantity_entry = ttk.Entry(self.root, width=40, font=("Arial", 10))
        self.quantity_entry.pack(pady=5)
        self.quantity_entry.insert(0, "65")
        
        ttk.Label(self.root, text="–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–ª–ª–µ—Ç—ã:", font=("Arial", 10)).pack(pady=8)
        self.date_entry = ttk.Entry(self.root, width=40, font=("Arial", 10))
        self.date_entry.pack(pady=5)
        self.date_entry.insert(0, "25.09.2025")
        
        ttk.Label(self.root, text="–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏:", font=("Arial", 10)).pack(pady=8)
        self.expiry_entry = ttk.Entry(self.root, width=40, font=("Arial", 10))
        self.expiry_entry.pack(pady=5)
        self.expiry_entry.insert(0, "–Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω")
        
        # –§—Ä–µ–π–º –¥–ª—è –∫–Ω–æ–ø–æ–∫
        button_frame = ttk.Frame(self.root)
        button_frame.pack(pady=20)
        
        # –ö–Ω–æ–ø–∫–∏
        ttk.Button(button_frame, text="üìÅ –í—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω DOCX", 
                  command=self.select_template, width=30).pack(pady=8)
        
        ttk.Button(button_frame, text="‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–ø–∏—é", 
                  command=self.modify_template_and_save, width=30).pack(pady=8)
    
    def select_template(self):
        """–í—ã–±–æ—Ä DOCX —Ñ–∞–π–ª–∞ —à–∞–±–ª–æ–Ω–∞"""
        filename = filedialog.askopenfilename(
            title="–í—ã–±–µ—Ä–∏—Ç–µ DOCX —Ñ–∞–π–ª —à–∞–±–ª–æ–Ω–∞",
            filetypes=[
                ("Word documents", "*.docx"),
                ("All files", "*.*")
            ]
        )
        if filename:
            self.template_path = filename
            messagebox.showinfo("–®–∞–±–ª–æ–Ω –≤—ã–±—Ä–∞–Ω", 
                              f"–®–∞–±–ª–æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:\n{os.path.basename(filename)}\n\n"
                              f"–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –µ–≥–æ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–ø–∏—é.")
    
    def generate_barcode(self, code):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞"""
        temp_dir = tempfile.gettempdir()
        barcode_path = os.path.join(temp_dir, 'temp_barcode')
        
        writer = ImageWriter()
        writer.options = {
            'module_width': 0.15,
            'module_height': 12.0,
            'quiet_zone': 3.0,
            'font_size': 8,
            'text_distance': 2.0
        }
        
        barcode = Code128(code, writer=writer)
        filename = barcode.save(barcode_path)
        return filename
    
    def replace_text_in_document(self, doc, old_text, new_text):
        """–ó–∞–º–µ–Ω–∞ —Ç–µ–∫—Å—Ç–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ"""
        replaced = False
        
        # –ò—â–µ–º –≤ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞—Ö
        for paragraph in doc.paragraphs:
            if old_text in paragraph.text:
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                for run in paragraph.runs:
                    if old_text in run.text:
                        run.text = run.text.replace(old_text, new_text)
                        replaced = True
        
        # –ò—â–µ–º –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö
        for table in doc.tables:
            for row in table.rows:
                for cell in row.cells:
                    if old_text in cell.text:
                        for paragraph in cell.paragraphs:
                            for run in paragraph.runs:
                                if old_text in run.text:
                                    run.text = run.text.replace(old_text, new_text)
                                    replaced = True
        
        return replaced
    
    def replace_barcode_image(self, doc, new_barcode_path):
        """–ó–∞–º–µ–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ"""
        try:
            # –ù–∞—Ö–æ–¥–∏–º –∏ —É–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            for rel in doc.part.rels.values():
                if "image" in rel.target_ref:
                    # –£–¥–∞–ª—è–µ–º —Å–≤—è–∑—å —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
                    doc.part.rels[rel.rId]._target = None
            
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            first_paragraph = doc.paragraphs[0] if doc.paragraphs else doc.add_paragraph()
            run = first_paragraph.add_run()
            run.add_picture(new_barcode_path, width=Inches(2.2))
            
            return True
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–º–µ–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
            return False
    
    def modify_template_and_save(self):
        """–ò–∑–º–µ–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–ø–∏–∏ –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª"""
        try:
            if not self.template_path or not os.path.exists(self.template_path):
                messagebox.showerror("–û—à–∏–±–∫–∞", "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω DOCX")
                return
            
            # –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é —à–∞–±–ª–æ–Ω–∞ –Ω–∞ —Ä–∞–±–æ—á–µ–º —Å—Ç–æ–ª–µ
            original_name = Path(self.template_path).stem
            new_filename = self.desktop_path / f"{original_name}_{self.barcode_entry.get()}.docx"
            
            # –ö–æ–ø–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω
            shutil.copy2(self.template_path, new_filename)
            
            # –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–æ–ø–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            doc = Document(new_filename)
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —à—Ç—Ä–∏—Ö-–∫–æ–¥
            barcode_filename = self.generate_barcode(self.barcode_entry.get())
            
            # –ó–∞–º–µ–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ
            replacements = {
                "01000000049721025000186840": self.barcode_entry.get(),
                '–í–∏—Å–∫–∏ "William Lawson\'s ", 0,5 –ª., 40%': self.product_entry.get(),
                "65": self.quantity_entry.get(),
                "25.09.2025": self.date_entry.get(),
                "–Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω": self.expiry_entry.get()
            }
            
            replaced_count = 0
            for old_text, new_text in replacements.items():
                if self.replace_text_in_document(doc, old_text, new_text):
                    replaced_count += 1
                    print(f"–ó–∞–º–µ–Ω–µ–Ω: {old_text} -> {new_text}")
            
            # –ó–∞–º–µ–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞
            image_replaced = self.replace_barcode_image(doc, barcode_filename)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            doc.save(new_filename)
            
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞
            if os.path.exists(barcode_filename):
                os.remove(barcode_filename)
            
            self.current_file = str(new_filename)
            
            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
            self.open_document()
            
            messagebox.showinfo("–ì–æ—Ç–æ–≤–æ!", 
                              f"–®–∞–±–ª–æ–Ω –∏–∑–º–µ–Ω–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª!\n\n"
                              f"–ò–º—è —Ñ–∞–π–ª–∞: {new_filename.name}\n"
                              f"–ó–∞–º–µ–Ω–µ–Ω–æ –ø–æ–ª–µ–π: {replaced_count}\n"
                              f"–®—Ç—Ä–∏—Ö-–∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω: {'–î–∞' if image_replaced else '–ù–µ—Ç'}\n\n"
                              f"–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω –æ—Å—Ç–∞–ª—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º.")
            
        except Exception as e:
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞: {str(e)}")
    
    def open_document(self):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
        try:
            if hasattr(self, 'current_file') and os.path.exists(self.current_file):
                if os.name == 'nt':  # Windows
                    os.startfile(self.current_file)
                elif os.name == 'posix':  # macOS, Linux
                    subprocess.run(['open', self.current_file] if os.name == 'posix' and os.uname().sysname == 'Darwin' else ['xdg-open', self.current_file])
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–∞–π–ª–∞: {e}")

if __name__ == "__main__":
    root = tk.Tk()
    app = PalletLabelEditor(root)
    root.mainloop()