import tkinter as tk
from tkinter import ttk, messagebox, filedialog
from docx import Document
from docx.shared import Mm, Pt
from docx.enum.text import WD_ALIGN_PARAGRAPH
from barcode import Code128
from barcode.writer import ImageWriter
import os
import tempfile
import subprocess
from pathlib import Path

class PalletLabelEditor:
    def __init__(self, root):
        self.root = root
        self.root.title("–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞–ª–ª–µ—Ç–Ω—ã—Ö —ç—Ç–∏–∫–µ—Ç–æ–∫")
        self.root.geometry("400x500")
        
        self.template_path = ""
        self.desktop_path = Path.home() / "Desktop"
        
        self.create_widgets()
    
    def create_widgets(self):
        # –ü–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö
        ttk.Label(self.root, text="–®—Ç—Ä–∏—Ö-–∫–æ–¥ (Code-128):", font=("Arial", 10)).pack(pady=8)
        self.barcode_entry = ttk.Entry(self.root, width=40, font=("Arial", 10))
        self.barcode_entry.pack(pady=5)
        self.barcode_entry.insert(0, "01000000049721025000186840")
        
        ttk.Label(self.root, text="–ö–æ–¥ –∏ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞:", font=("Arial", 10)).pack(pady=8)
        self.product_entry = ttk.Entry(self.root, width=40, font=("Arial", 10))
        self.product_entry.pack(pady=5)
        self.product_entry.insert(0, '–í–∏—Å–∫–∏ "William Lawson\'s ", 0,5 –ª., 40%')
        
        ttk.Label(self.root, text="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–æ–±–æ–≤:", font=("Arial", 10)).pack(pady=8)
        self.quantity_entry = ttk.Entry(self.root, width=40, font=("Arial", 10))
        self.quantity_entry.pack(pady=5)
        self.quantity_entry.insert(0, "65")
        
        ttk.Label(self.root, text="–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–ª–ª–µ—Ç—ã:", font=("Arial", 10)).pack(pady=8)
        self.date_entry = ttk.Entry(self.root, width=40, font=("Arial", 10))
        self.date_entry.pack(pady=5)
        self.date_entry.insert(0, "25.09.2025")
        
        ttk.Label(self.root, text="–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏:", font=("Arial", 10)).pack(pady=8)
        self.expiry_entry = ttk.Entry(self.root, width=40, font=("Arial", 10))
        self.expiry_entry.pack(pady=5)
        self.expiry_entry.insert(0, "–Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω")
        
        # –§—Ä–µ–π–º –¥–ª—è –∫–Ω–æ–ø–æ–∫
        button_frame = ttk.Frame(self.root)
        button_frame.pack(pady=20)
        
        # –ö–Ω–æ–ø–∫–∏
        ttk.Button(button_frame, text="üìÅ –í—ã–±—Ä–∞—Ç—å PDF —à–∞–±–ª–æ–Ω", 
                  command=self.select_pdf_template, width=30).pack(pady=8)
        
        ttk.Button(button_frame, text="üñ®Ô∏è –°–æ–∑–¥–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å PDF", 
                  command=self.create_and_save_pdf, width=30).pack(pady=8)
    
    def select_pdf_template(self):
        """–í—ã–±–æ—Ä PDF —Ñ–∞–π–ª–∞ —à–∞–±–ª–æ–Ω–∞"""
        filename = filedialog.askopenfilename(
            title="–í—ã–±–µ—Ä–∏—Ç–µ PDF —Ñ–∞–π–ª —à–∞–±–ª–æ–Ω–∞",
            filetypes=[
                ("PDF files", "*.pdf"),
                ("All files", "*.*")
            ]
        )
        if filename:
            self.template_path = filename
            messagebox.showinfo("PDF —à–∞–±–ª–æ–Ω –≤—ã–±—Ä–∞–Ω", 
                              f"PDF —à–∞–±–ª–æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:\n{os.path.basename(filename)}")
    
    def generate_barcode(self, code):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏"""
        temp_dir = tempfile.gettempdir()
        barcode_path = os.path.join(temp_dir, 'temp_barcode')
        
        writer = ImageWriter()
        writer.options = {
            'module_width': 0.15,
            'module_height': 12.0,
            'quiet_zone': 3.0,
            'font_size': 8,
            'text_distance': 2.0
        }
        
        barcode = Code128(code, writer=writer)
        filename = barcode.save(barcode_path)
        return filename
    
    def convert_docx_to_pdf(self, docx_path, pdf_path):
        """–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è DOCX –≤ PDF"""
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º LibreOffice –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
            if os.name == 'nt':  # Windows
                libreoffice_path = "C:\\Program Files\\LibreOffice\\program\\soffice.exe"
                if not os.path.exists(libreoffice_path):
                    libreoffice_path = "soffice"  # –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤ PATH
            else:  # Linux/Mac
                libreoffice_path = "libreoffice"
            
            cmd = [
                libreoffice_path,
                '--headless',
                '--convert-to', 'pdf',
                '--outdir', str(Path(pdf_path).parent),
                docx_path
            ]
            
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=30)
            
            if result.returncode == 0:
                # LibreOffice —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º –Ω–æ .pdf
                expected_pdf = Path(docx_path).with_suffix('.pdf')
                if expected_pdf.exists():
                    # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ –Ω—É–∂–Ω–æ–µ –º–µ—Å—Ç–æ —Å –Ω—É–∂–Ω—ã–º –∏–º–µ–Ω–µ–º
                    if expected_pdf != Path(pdf_path):
                        expected_pdf.rename(pdf_path)
                    return True
            return False
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: {e}")
            return False
    
    def create_and_save_pdf(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF"""
        try:
            doc = Document()
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç A5 –≤ –ê–õ–¨–ë–û–ú–ù–û–ô –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
            section = doc.sections[0]
            section.page_height = Mm(148)   # A5 —à–∏—Ä–∏–Ω–∞ -> —Ç–µ–ø–µ—Ä—å –≤—ã—Å–æ—Ç–∞
            section.page_width = Mm(210)    # A5 –≤—ã—Å–æ—Ç–∞ -> —Ç–µ–ø–µ—Ä—å —à–∏—Ä–∏–Ω–∞
            section.top_margin = Mm(10)
            section.bottom_margin = Mm(10)
            section.left_margin = Mm(10)
            section.right_margin = Mm(10)
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —à—Ç—Ä–∏—Ö-–∫–æ–¥
            barcode_filename = self.generate_barcode(self.barcode_entry.get())
            
            # –î–æ–±–∞–≤–ª—è–µ–º —à—Ç—Ä–∏—Ö-–∫–æ–¥
            doc.add_picture(barcode_filename, width=Mm(180))
            
            # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
            doc.add_paragraph()
            
            # –ù–æ–º–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ (–ø–æ —Ü–µ–Ω—Ç—Ä—É, –∂–∏—Ä–Ω—ã–π)
            p = doc.add_paragraph()
            p.alignment = WD_ALIGN_PARAGRAPH.CENTER
            run = p.add_run(self.barcode_entry.get())
            run.bold = True
            run.font.size = Pt(11)
            run.font.name = 'Arial'
            
            # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
            doc.add_paragraph()
            
            # –ö–æ–¥ –∏ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
            p = doc.add_paragraph()
            run = p.add_run("–ö–æ–¥ –∏ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞:")
            run.font.size = Pt(10)
            run.font.name = 'Arial'
            
            p = doc.add_paragraph()
            run = p.add_run(self.product_entry.get())
            run.bold = True
            run.font.size = Pt(10)
            run.font.name = 'Arial'
            
            # –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å
            p = doc.add_paragraph()
            run = p.add_run("–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å: –û–û–û ¬´–ó–∞–≤–æ–¥ –ì–µ–æ—Ä–≥–∏–µ–≤—Å–∫–∏–π. –¢—Ä–∞–¥–∏—Ü–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞¬ª.")
            run.font.size = Pt(10)
            run.font.name = 'Arial'
            
            # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–æ–±–æ–≤
            p = doc.add_paragraph()
            run = p.add_run("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–æ–±–æ–≤:")
            run.font.size = Pt(10)
            run.font.name = 'Arial'
            
            p = doc.add_paragraph()
            run = p.add_run(self.quantity_entry.get())
            run.bold = True
            run.font.size = Pt(10)
            run.font.name = 'Arial'
            
            # –î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–ª–ª–µ—Ç—ã
            p = doc.add_paragraph()
            run = p.add_run("–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–ª–ª–µ—Ç—ã:")
            run.font.size = Pt(10)
            run.font.name = 'Arial'
            
            p = doc.add_paragraph()
            run = p.add_run(self.date_entry.get())
            run.bold = True
            run.font.size = Pt(10)
            run.font.name = 'Arial'
            
            # –°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏
            p = doc.add_paragraph()
            run = p.add_run("–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏:")
            run.font.size = Pt(10)
            run.font.name = 'Arial'
            
            p = doc.add_paragraph()
            run = p.add_run(self.expiry_entry.get())
            run.bold = True
            run.font.size = Pt(10)
            run.font.name = 'Arial'
            
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π DOCX —Ñ–∞–π–ª
            temp_dir = tempfile.gettempdir()
            temp_docx = os.path.join(temp_dir, f"temp_{self.barcode_entry.get()}.docx")
            doc.save(temp_docx)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–π PDF –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª
            pdf_filename = self.desktop_path / f"{self.barcode_entry.get()}.pdf"
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ PDF
            if self.convert_docx_to_pdf(temp_docx, str(pdf_filename)):
                # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
                if os.path.exists(barcode_filename):
                    os.remove(barcode_filename)
                if os.path.exists(temp_docx):
                    os.remove(temp_docx)
                
                self.current_file = str(pdf_filename)
                
                # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º PDF
                self.open_document()
                
                messagebox.showinfo("–ì–æ—Ç–æ–≤–æ!", 
                                  f"PDF –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª!\n\n"
                                  f"–ò–º—è —Ñ–∞–π–ª–∞: {self.barcode_entry.get()}.pdf\n"
                                  f"–§–æ—Ä–º–∞—Ç: A5 (–∞–ª—å–±–æ–º–Ω—ã–π)\n"
                                  f"–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: –†–∞–±–æ—á–∏–π —Å—Ç–æ–ª")
            else:
                messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", 
                                     "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å PDF —Ñ–∞–π–ª.\n"
                                     "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ LibreOffice –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ PDF.\n\n"
                                     "–í—Ä–µ–º–µ–Ω–Ω—ã–π DOCX —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω:\n" + temp_docx)
            
        except Exception as e:
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF: {str(e)}")
    
    def open_document(self):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ PDF"""
        try:
            if hasattr(self, 'current_file') and os.path.exists(self.current_file):
                if os.name == 'nt':  # Windows
                    os.startfile(self.current_file)
                elif os.name == 'posix':  # macOS, Linux
                    subprocess.run(['open', self.current_file] if os.name == 'posix' and os.uname().sysname == 'Darwin' else ['xdg-open', self.current_file])
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–∞–π–ª–∞: {e}")

if __name__ == "__main__":
    root = tk.Tk()
    app = PalletLabelEditor(root)
    root.mainloop()