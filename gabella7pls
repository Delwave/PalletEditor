import tkinter as tk
from tkinter import ttk, messagebox, filedialog
from docx import Document
from docx.shared import Inches, Mm
from barcode import Code128
from barcode.writer import ImageWriter
import os
import tempfile
import subprocess
import shutil

class PalletLabelEditor:
    def __init__(self, root):
        self.root = root
        self.root.title("Редактор паллетных этикеток")
        self.root.geometry("400x600")
        
        self.template_path = "шаблон паллетного.docx"
        
        self.create_widgets()
    
    def create_widgets(self):
        # Поля для ввода данных
        ttk.Label(self.root, text="Штрих-код (Code-128):").pack(pady=5)
        self.barcode_entry = ttk.Entry(self.root, width=40)
        self.barcode_entry.pack(pady=5)
        self.barcode_entry.insert(0, "01000000049721025000186840")
        
        ttk.Label(self.root, text="Код и наименование продукта:").pack(pady=5)
        self.product_entry = ttk.Entry(self.root, width=40)
        self.product_entry.pack(pady=5)
        self.product_entry.insert(0, 'Виски "William Lawson\'s ", 0,5 л., 40%')
        
        ttk.Label(self.root, text="Количество коробов:").pack(pady=5)
        self.quantity_entry = ttk.Entry(self.root, width=40)
        self.quantity_entry.pack(pady=5)
        self.quantity_entry.insert(0, "65")
        
        ttk.Label(self.root, text="Дата закрытия паллеты:").pack(pady=5)
        self.date_entry = ttk.Entry(self.root, width=40)
        self.date_entry.pack(pady=5)
        self.date_entry.insert(0, "25.09.2025")
        
        ttk.Label(self.root, text="Срок годности:").pack(pady=5)
        self.expiry_entry = ttk.Entry(self.root, width=40)
        self.expiry_entry.pack(pady=5)
        self.expiry_entry.insert(0, "не ограничен")
        
        # Фрейм для кнопок
        button_frame = ttk.Frame(self.root)
        button_frame.pack(pady=20)
        
        # Кнопки
        ttk.Button(button_frame, text="Создать НОВЫЙ документ с моими данными", 
                  command=self.create_new_document).pack(pady=5, fill='x')
        
        ttk.Button(button_frame, text="Сохранить как...", 
                  command=self.save_document).pack(pady=5, fill='x')
        
        ttk.Button(button_frame, text="Открыть для печати", 
                  command=self.open_for_print).pack(pady=5, fill='x')
        
        ttk.Button(button_frame, text="Выбрать шаблон...", 
                  command=self.select_template).pack(pady=5, fill='x')
    
    def select_template(self):
        """Выбор файла шаблона"""
        filename = filedialog.askopenfilename(
            title="Выберите файл шаблона",
            filetypes=[
                ("Word documents", "*.docx"),
                ("All files", "*.*")
            ]
        )
        if filename:
            self.template_path = filename
            messagebox.showinfo("Шаблон выбран", f"Шаблон установлен: {os.path.basename(filename)}")
    
    def generate_barcode(self, code):
        """Генерация штрих-кода"""
        temp_dir = tempfile.gettempdir()
        barcode_path = os.path.join(temp_dir, 'temp_barcode')
        
        writer = ImageWriter()
        writer.options = {
            'module_width': 0.2,
            'module_height': 15.0,
            'quiet_zone': 6.5,
            'font_size': 10,
            'text_distance': 5.0
        }
        
        barcode = Code128(code, writer=writer)
        filename = barcode.save(barcode_path)
        return filename
    
    def create_new_document(self):
        """Создание полностью нового документа в стиле шаблона"""
        try:
            doc = Document()
            
            # Устанавливаем формат A5
            section = doc.sections[0]
            section.page_height = Mm(210)
            section.page_width = Mm(148)
            section.top_margin = Mm(8)
            section.bottom_margin = Mm(8)
            section.left_margin = Mm(8)
            section.right_margin = Mm(8)
            
            # Генерируем и добавляем штрих-код
            barcode_filename = self.generate_barcode(self.barcode_entry.get())
            doc.add_picture(barcode_filename, width=Mm(130))
            
            # Пустая строка
            doc.add_paragraph()
            
            # Номер штрих-кода (жирный, по центру)
            p = doc.add_paragraph()
            p.alignment = 1  # По центру
            run = p.add_run(self.barcode_entry.get())
            run.bold = True
            run.font.size = Mm(4)
            
            # Пустая строка
            doc.add_paragraph()
            
            # Код и наименование продукта
            p = doc.add_paragraph()
            run = p.add_run("Код и наименование продукта:")
            run.font.size = Mm(3)
            
            p = doc.add_paragraph()
            run = p.add_run(self.product_entry.get())
            run.bold = True
            run.font.size = Mm(3)
            
            # Производитель
            p = doc.add_paragraph()
            run = p.add_run("Производитель: ООО «Завод Георгиевский. Традиции качества».")
            run.font.size = Mm(3)
            
            # Количество коробов
            p = doc.add_paragraph()
            run = p.add_run("Количество коробов:")
            run.font.size = Mm(3)
            
            p = doc.add_paragraph()
            run = p.add_run(self.quantity_entry.get())
            run.bold = True
            run.font.size = Mm(3)
            
            # Дата закрытия паллеты
            p = doc.add_paragraph()
            run = p.add_run("Дата закрытия паллеты:")
            run.font.size = Mm(3)
            
            p = doc.add_paragraph()
            run = p.add_run(self.date_entry.get())
            run.bold = True
            run.font.size = Mm(3)
            
            # Срок годности
            p = doc.add_paragraph()
            run = p.add_run("Срок годности:")
            run.font.size = Mm(3)
            
            p = doc.add_paragraph()
            run = p.add_run(self.expiry_entry.get())
            run.bold = True
            run.font.size = Mm(3)
            
            # Сохраняем документ
            filename = f"паллетная_этикетка_{self.barcode_entry.get()}.docx"
            doc.save(filename)
            
            # Удаляем временный файл штрих-кода
            if os.path.exists(barcode_filename):
                os.remove(barcode_filename)
            
            self.current_file = filename
            messagebox.showinfo("Успех", 
                              f"Новый документ создан!\n"
                              f"Сохранен как: {filename}\n\n"
                              f"Все ваши данные внесены корректно!")
            
        except Exception as e:
            messagebox.showerror("Ошибка", f"Ошибка при создании документа: {str(e)}")
    
    def save_document(self):
        """Сохранение документа с выбором пути"""
        try:
            if not hasattr(self, 'current_file'):
                messagebox.showwarning("Предупреждение", "Сначала создайте документ")
                return
            
            filename = filedialog.asksaveasfilename(
                defaultextension=".docx",
                filetypes=[
                    ("Word documents", "*.docx"),
                    ("All files", "*.*")
                ],
                title="Сохранить документ как..."
            )
            
            if filename:
                shutil.copy2(self.current_file, filename)
                self.current_file = filename
                messagebox.showinfo("Успех", f"Документ сохранен как: {filename}")
                
        except Exception as e:
            messagebox.showerror("Ошибка", f"Ошибка при сохранении: {str(e)}")
    
    def open_for_print(self):
        """Открытие документа для ручной печати"""
        try:
            if hasattr(self, 'current_file') and os.path.exists(self.current_file):
                if os.name == 'nt':
                    os.startfile(self.current_file)
                elif os.name == 'posix':
                    subprocess.run(['open', self.current_file] if os.name == 'posix' and os.uname().sysname == 'Darwin' else ['xdg-open', self.current_file])
                
                messagebox.showinfo("Открытие", 
                                  "Документ открыт в Word.\n"
                                  "Формат A5 уже установлен.")
            else:
                messagebox.showwarning("Предупреждение", 
                                     "Сначала создайте документ")
                
        except Exception as e:
            messagebox.showerror("Ошибка", f"Ошибка при открытии файла: {str(e)}")

if __name__ == "__main__":
    root = tk.Tk()
    app = PalletLabelEditor(root)
    root.mainloop()