import tkinter as tk
from tkinter import ttk, messagebox, filedialog
from docx import Document
from barcode import Code128
from barcode.writer import ImageWriter
import os
import tempfile
import subprocess
import shutil

class PalletLabelEditor:
    def __init__(self, root):
        self.root = root
        self.root.title("Редактор паллетных этикеток")
        self.root.geometry("400x550")
        
        # Путь к шаблону - замените на реальный путь к вашему файлу
        self.template_path = "шаблон паллетного.docx"
        
        self.create_widgets()
    
    def create_widgets(self):
        # Поля для ввода данных
        ttk.Label(self.root, text="Штрих-код (Code-128):").pack(pady=5)
        self.barcode_entry = ttk.Entry(self.root, width=40)
        self.barcode_entry.pack(pady=5)
        self.barcode_entry.insert(0, "01000000049721025000186840")
        
        ttk.Label(self.root, text="Код и наименование продукта:").pack(pady=5)
        self.product_entry = ttk.Entry(self.root, width=40)
        self.product_entry.pack(pady=5)
        self.product_entry.insert(0, 'Виски "William Lawson\'s ", 0,5 л., 40%')
        
        ttk.Label(self.root, text="Количество коробов:").pack(pady=5)
        self.quantity_entry = ttk.Entry(self.root, width=40)
        self.quantity_entry.pack(pady=5)
        self.quantity_entry.insert(0, "65")
        
        ttk.Label(self.root, text="Дата закрытия паллеты:").pack(pady=5)
        self.date_entry = ttk.Entry(self.root, width=40)
        self.date_entry.pack(pady=5)
        self.date_entry.insert(0, "25.09.2025")
        
        ttk.Label(self.root, text="Срок годности:").pack(pady=5)
        self.expiry_entry = ttk.Entry(self.root, width=40)
        self.expiry_entry.pack(pady=5)
        self.expiry_entry.insert(0, "не ограничен")
        
        # Фрейм для кнопок
        button_frame = ttk.Frame(self.root)
        button_frame.pack(pady=20)
        
        # Кнопки
        ttk.Button(button_frame, text="Создать из шаблона", 
                  command=self.create_from_template).pack(pady=5, fill='x')
        
        ttk.Button(button_frame, text="Сохранить как...", 
                  command=self.save_document).pack(pady=5, fill='x')
        
        ttk.Button(button_frame, text="Открыть для печати", 
                  command=self.open_for_print).pack(pady=5, fill='x')
        
        # Кнопка выбора шаблона
        ttk.Button(button_frame, text="Выбрать шаблон...", 
                  command=self.select_template).pack(pady=5, fill='x')
    
    def select_template(self):
        """Выбор файла шаблона"""
        filename = filedialog.askopenfilename(
            title="Выберите файл шаблона",
            filetypes=[
                ("Word documents", "*.docx"),
                ("All files", "*.*")
            ]
        )
        if filename:
            self.template_path = filename
            messagebox.showinfo("Шаблон выбран", f"Шаблон установлен: {os.path.basename(filename)}")
    
    def generate_barcode(self, code):
        """Генерация штрих-кода"""
        temp_dir = tempfile.gettempdir()
        barcode_path = os.path.join(temp_dir, 'temp_barcode')
        
        writer = ImageWriter()
        writer.options = {
            'module_width': 0.2,
            'module_height': 15.0,
            'quiet_zone': 6.5,
            'font_size': 10,
            'text_distance': 5.0
        }
        
        barcode = Code128(code, writer=writer)
        filename = barcode.save(barcode_path)
        return filename
    
    def find_and_replace(self, doc, old_text, new_text):
        """Поиск и замена текста в документе"""
        for paragraph in doc.paragraphs:
            if old_text in paragraph.text:
                for run in paragraph.runs:
                    if old_text in run.text:
                        run.text = run.text.replace(old_text, new_text)
        
        # Также ищем в таблицах
        for table in doc.tables:
            for row in table.rows:
                for cell in row.cells:
                    for paragraph in cell.paragraphs:
                        if old_text in paragraph.text:
                            for run in paragraph.runs:
                                if old_text in run.text:
                                    run.text = run.text.replace(old_text, new_text)
    
    def create_from_template(self):
        """Создание документа из шаблона"""
        try:
            # Проверяем существование шаблона
            if not os.path.exists(self.template_path):
                messagebox.showerror("Ошибка", 
                                   f"Файл шаблона не найден:\n{self.template_path}\n\nИспользуйте кнопку 'Выбрать шаблон...'")
                return
            
            # Создаем копию шаблона
            temp_dir = tempfile.gettempdir()
            temp_doc_path = os.path.join(temp_dir, "temp_pallet_label.docx")
            shutil.copy2(self.template_path, temp_doc_path)
            
            # Открываем копию для редактирования
            doc = Document(temp_doc_path)
            
            # Генерируем новый штрих-код
            barcode_filename = self.generate_barcode(self.barcode_entry.get())
            
            # Заменяем данные в документе
            replacements = {
                "01000000049721025000186840": self.barcode_entry.get(),
                'Виски "William Lawson\'s ", 0,5 л., 40%': self.product_entry.get(),
                "65": self.quantity_entry.get(),
                "25.09.2025": self.date_entry.get(),
                "не ограничен": self.expiry_entry.get()
            }
            
            for old_text, new_text in replacements.items():
                self.find_and_replace(doc, old_text, new_text)
            
            # Сохраняем измененный документ
            filename = f"паллетная_этикетка_{self.barcode_entry.get()}.docx"
            doc.save(filename)
            
            # Удаляем временные файлы
            if os.path.exists(barcode_filename):
                os.remove(barcode_filename)
            if os.path.exists(temp_doc_path):
                os.remove(temp_doc_path)
            
            self.current_file = filename
            messagebox.showinfo("Успех", 
                              f"Документ создан из шаблона!\n"
                              f"Сохранен как: {filename}\n\n"
                              f"Шаблон остался неизменным: {os.path.basename(self.template_path)}")
            
        except Exception as e:
            messagebox.showerror("Ошибка", f"Ошибка при создании документа: {str(e)}")
    
    def save_document(self):
        """Сохранение документа с выбором пути"""
        try:
            if not hasattr(self, 'current_file'):
                messagebox.showwarning("Предупреждение", "Сначала создайте документ")
                return
            
            # Диалог выбора пути сохранения
            filename = filedialog.asksaveasfilename(
                defaultextension=".docx",
                filetypes=[
                    ("Word documents", "*.docx"),
                    ("All files", "*.*")
                ],
                title="Сохранить документ как..."
            )
            
            if filename:
                shutil.copy2(self.current_file, filename)
                self.current_file = filename
                messagebox.showinfo("Успех", f"Документ сохранен как: {filename}")
                
        except Exception as e:
            messagebox.showerror("Ошибка", f"Ошибка при сохранении: {str(e)}")
    
    def open_for_print(self):
        """Открытие документа для ручной печати"""
        try:
            if hasattr(self, 'current_file') and os.path.exists(self.current_file):
                # Открываем файл в ассоциированной программе
                if os.name == 'nt':  # Windows
                    os.startfile(self.current_file)
                elif os.name == 'posix':  # macOS, Linux
                    subprocess.run(['open', self.current_file] if os.name == 'posix' and os.uname().sysname == 'Darwin' else ['xdg-open', self.current_file])
                
                messagebox.showinfo("Открытие", 
                                  "Документ открыт в программе по умолчанию.\n"
                                  "Все настройки форматирования сохранены из шаблона.")
            else:
                messagebox.showwarning("Предупреждение", 
                                     "Сначала создайте и сохраните документ")
                
        except Exception as e:
            messagebox.showerror("Ошибка", f"Ошибка при открытии файла: {str(e)}")

if __name__ == "__main__":
    root = tk.Tk()
    app = PalletLabelEditor(root)
    root.mainloop()