import tkinter as tk
from tkinter import ttk, messagebox
from docx import Document
from docx.shared import Mm
from barcode import Code128
from barcode.writer import ImageWriter
import os
from PIL import Image

class PalletLabelEditor:
    def __init__(self, root):
        self.root = root
        self.root.title("Редактор паллетных этикеток")
        self.root.geometry("400x500")
        
        self.create_widgets()
    
    def create_widgets(self):
        # Поля для ввода данных
        ttk.Label(self.root, text="Штрих-код (Code-128):").pack(pady=5)
        self.barcode_entry = ttk.Entry(self.root, width=40)
        self.barcode_entry.pack(pady=5)
        self.barcode_entry.insert(0, "01000000049721025000186840")
        
        ttk.Label(self.root, text="Код и наименование продукта:").pack(pady=5)
        self.product_entry = ttk.Entry(self.root, width=40)
        self.product_entry.pack(pady=5)
        self.product_entry.insert(0, 'Виски "William Lawson\'s ", 0,5 л., 40%')
        
        ttk.Label(self.root, text="Количество коробов:").pack(pady=5)
        self.quantity_entry = ttk.Entry(self.root, width=40)
        self.quantity_entry.pack(pady=5)
        self.quantity_entry.insert(0, "65")
        
        ttk.Label(self.root, text="Дата закрытия паллеты:").pack(pady=5)
        self.date_entry = ttk.Entry(self.root, width=40)
        self.date_entry.pack(pady=5)
        self.date_entry.insert(0, "25.09.2025")
        
        ttk.Label(self.root, text="Срок годности:").pack(pady=5)
        self.expiry_entry = ttk.Entry(self.root, width=40)
        self.expiry_entry.pack(pady=5)
        self.expiry_entry.insert(0, "не ограничен")
        
        # Кнопки
        ttk.Button(self.root, text="Создать документ", 
                  command=self.create_document).pack(pady=10)
        
        ttk.Button(self.root, text="Печать", 
                  command=self.print_document).pack(pady=5)
    
    def generate_barcode(self, code):
        """Генерация штрих-кода"""
        barcode = Code128(code, writer=ImageWriter())
        filename = barcode.save('temp_barcode')
        return filename + '.png'
    
    def create_document(self):
        """Создание документа Word"""
        try:
            doc = Document()
            
            # Настройка страницы A5
            section = doc.sections[0]
            section.page_height = Mm(210)
            section.page_width = Mm(148)
            section.top_margin = Mm(10)
            section.bottom_margin = Mm(10)
            section.left_margin = Mm(10)
            section.right_margin = Mm(10)
            
            # Генерация штрих-кода
            barcode_filename = self.generate_barcode(self.barcode_entry.get())
            
            # Добавление штрих-кода в документ
            doc.add_picture(barcode_filename, width=Mm(120))
            
            # Добавление номера штрих-кода
            p = doc.add_paragraph()
            p.add_run(self.barcode_entry.get()).bold = True
            
            # Добавление остальных данных
            doc.add_paragraph("Код и наименование продукта:")
            p = doc.add_paragraph()
            p.add_run(self.product_entry.get()).bold = True
            
            doc.add_paragraph("Производитель: ООО «Завод Георгиевский. Традиции качества».")
            
            doc.add_paragraph("Количество коробов:")
            p = doc.add_paragraph()
            p.add_run(self.quantity_entry.get()).bold = True
            
            doc.add_paragraph("Дата закрытия паллеты:")
            p = doc.add_paragraph()
            p.add_run(self.date_entry.get()).bold = True
            
            doc.add_paragraph("Срок годности:")
            p = doc.add_paragraph()
            p.add_run(self.expiry_entry.get()).bold = True
            
            # Сохранение документа
            filename = f"паллетная_этикетка_{self.barcode_entry.get()}.docx"
            doc.save(filename)
            
            # Удаление временного файла штрих-кода
            if os.path.exists(barcode_filename):
                os.remove(barcode_filename)
            
            self.current_file = filename
            messagebox.showinfo("Успех", f"Документ сохранен как: {filename}")
            
        except Exception as e:
            messagebox.showerror("Ошибка", f"Ошибка при создании документа: {e}")
    
    def print_document(self):
        """Печать документа"""
        try:
            if hasattr(self, 'current_file'):
                os.startfile(self.current_file, "print")
                messagebox.showinfo("Печать", "Документ отправлен на печать")
            else:
                messagebox.showwarning("Предупреждение", "Сначала создайте документ")
        except Exception as e:
            messagebox.showerror("Ошибка", f"Ошибка при печати: {e}")

if __name__ == "__main__":
    root = tk.Tk()
    app = PalletLabelEditor(root)
    root.mainloop()