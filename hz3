import tkinter as tk
from tkinter import ttk, messagebox, filedialog
from docx import Document
from docx.shared import Inches, Mm
from barcode import Code128
from barcode.writer import ImageWriter
import os
import tempfile
import subprocess
from pathlib import Path

class PalletLabelEditor:
    def __init__(self, root):
        self.root = root
        self.root.title("–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞–ª–ª–µ—Ç–Ω—ã—Ö —ç—Ç–∏–∫–µ—Ç–æ–∫")
        self.root.geometry("450x550")
        
        self.desktop_path = Path.home() / "Desktop"
        self.current_template = None
        
        self.create_widgets()
    
    def create_widgets(self):
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        title_label = ttk.Label(self.root, text="–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∞–ª–ª–µ—Ç–Ω—ã—Ö —ç—Ç–∏–∫–µ—Ç–æ–∫", 
                               font=("Arial", 12, "bold"))
        title_label.pack(pady=10)
        
        # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–∞
        ttk.Button(self.root, text="üìÅ –í—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω DOCX", 
                  command=self.select_template, width=30).pack(pady=10)
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —à–∞–±–ª–æ–Ω–µ
        self.template_info = ttk.Label(self.root, text="–®–∞–±–ª–æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω", 
                                      font=("Arial", 9), foreground="red")
        self.template_info.pack(pady=5)
        
        # –ü–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö
        fields = [
            ("–®—Ç—Ä–∏—Ö-–∫–æ–¥ (Code-128):", "barcode_entry", "01000000049721025000186840"),
            ("–ö–æ–¥ –∏ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞:", "product_entry", '–í–∏—Å–∫–∏ "William Lawson\'s ", 0,5 –ª., 40%'),
            ("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–æ–±–æ–≤:", "quantity_entry", "65"),
            ("–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–ª–ª–µ—Ç—ã:", "date_entry", "25.09.2025"),
            ("–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏:", "expiry_entry", "–Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω")
        ]
        
        for label_text, attr_name, default_value in fields:
            ttk.Label(self.root, text=label_text, font=("Arial", 9)).pack(pady=3)
            entry = ttk.Entry(self.root, width=50, font=("Arial", 9))
            entry.pack(pady=2)
            entry.insert(0, default_value)
            setattr(self, attr_name, entry)
        
        # –§—Ä–µ–π–º –¥–ª—è –∫–Ω–æ–ø–æ–∫
        button_frame = ttk.Frame(self.root)
        button_frame.pack(pady=20)
        
        # –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        self.save_btn = ttk.Button(button_frame, text="üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —à–∞–±–ª–æ–Ω–µ", 
                                  command=self.save_changes, width=30, state="disabled")
        self.save_btn.pack(pady=10)
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        info_label = ttk.Label(self.root, 
                              text="–í–ù–ò–ú–ê–ù–ò–ï: –®–∞–±–ª–æ–Ω –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω!",
                              font=("Arial", 8), foreground="red", justify='center')
        info_label.pack(pady=5)
    
    def select_template(self):
        """–í—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ DOCX"""
        filename = filedialog.askopenfilename(
            title="–í—ã–±–µ—Ä–∏—Ç–µ DOCX —Ñ–∞–π–ª —à–∞–±–ª–æ–Ω–∞",
            filetypes=[
                ("Word documents", "*.docx"),
                ("All files", "*.*")
            ]
        )
        if filename:
            self.current_template = filename
            self.template_info.config(
                text=f"–í—ã–±—Ä–∞–Ω: {os.path.basename(filename)}", 
                foreground="green"
            )
            self.save_btn.config(state="normal")
            messagebox.showinfo("–®–∞–±–ª–æ–Ω –≤—ã–±—Ä–∞–Ω", 
                              f"–®–∞–±–ª–æ–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!\n\n"
                              f"–§–∞–π–ª: {os.path.basename(filename)}\n"
                              f"–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω.")
    
    def generate_barcode(self, code):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ –ë–ï–ó —Ü–∏—Ñ—Ä –ø–æ–¥ –Ω–∏–º"""
        temp_dir = tempfile.gettempdir()
        barcode_path = os.path.join(temp_dir, f'temp_barcode_{code}')
        
        writer = ImageWriter()
        writer.options = {
            'module_width': 0.2,
            'module_height': 50.0,
            'quiet_zone': 2.0,
            'write_text': False,  # –ë–µ–∑ —Ü–∏—Ñ—Ä
            'background': 'white',
            'foreground': 'black',
        }
        
        barcode = Code128(code, writer=writer)
        filename = barcode.save(barcode_path)
        return filename
    
    def replace_text_in_document(self, doc, old_text, new_text):
        """–ó–∞–º–µ–Ω–∞ —Ç–µ–∫—Å—Ç–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ"""
        replaced = False
        
        # –ò—â–µ–º –≤ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞—Ö
        for paragraph in doc.paragraphs:
            if old_text in paragraph.text:
                for run in paragraph.runs:
                    if old_text in run.text:
                        run.text = run.text.replace(old_text, new_text)
                        replaced = True
        
        # –ò—â–µ–º –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö
        for table in doc.tables:
            for row in table.rows:
                for cell in row.cells:
                    if old_text in cell.text:
                        for paragraph in cell.paragraphs:
                            for run in paragraph.runs:
                                if old_text in run.text:
                                    run.text = run.text.replace(old_text, new_text)
                                    replaced = True
        
        return replaced
    
    def replace_barcode_image(self, doc, new_barcode_path):
        """–ó–∞–º–µ–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞"""
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏ –∑–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            for paragraph in doc.paragraphs:
                for run in paragraph.runs:
                    for inline_shape in run.inline_shapes:
                        if inline_shape.type == 3:  # 3 = picture
                            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                            run._r.clear()
                            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
                            run.add_picture(new_barcode_path, width=Inches(2.2))
                            return True
            
            # –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ø–µ—Ä–≤—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ
            if doc.paragraphs:
                first_paragraph = doc.paragraphs[0]
                run = first_paragraph.add_run()
                run.add_picture(new_barcode_path, width=Inches(2.2))
                return True
            
            return False
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–º–µ–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
            return False
    
    def save_changes(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —à–∞–±–ª–æ–Ω–µ"""
        try:
            if not self.current_template or not os.path.exists(self.current_template):
                messagebox.showerror("–û—à–∏–±–∫–∞", "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω!")
                return
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            barcode_text = self.barcode_entry.get().strip()
            if not barcode_text:
                messagebox.showerror("–û—à–∏–±–∫–∞", "–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥!")
                return
            
            # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
            result = messagebox.askyesno(
                "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", 
                f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Ñ–∞–π–ª?\n\n"
                f"–§–∞–π–ª: {os.path.basename(self.current_template)}\n"
                f"–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!",
                icon='warning'
            )
            
            if not result:
                return
            
            # –û—Ç–∫—Ä—ã–≤–∞–µ–º —à–∞–±–ª–æ–Ω –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            doc = Document(self.current_template)
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —à—Ç—Ä–∏—Ö-–∫–æ–¥
            barcode_filename = self.generate_barcode(barcode_text)
            
            # –î–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–º–µ–Ω—ã
            replacements = {
                "01000000049721025000186840": barcode_text,
                '–í–∏—Å–∫–∏ "William Lawson\'s ", 0,5 –ª., 40%': self.product_entry.get().strip(),
                "65": self.quantity_entry.get().strip(),
                "25.09.2025": self.date_entry.get().strip(),
                "–Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω": self.expiry_entry.get().strip()
            }
            
            # –ó–∞–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç
            replaced_count = 0
            for old_text, new_text in replacements.items():
                if self.replace_text_in_document(doc, old_text, new_text):
                    replaced_count += 1
            
            # –ó–∞–º–µ–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞
            image_replaced = self.replace_barcode_image(doc, barcode_filename)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –í –¢–û–¢ –ñ–ï –§–ê–ô–õ
            doc.save(self.current_template)
            
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞
            if os.path.exists(barcode_filename):
                os.remove(barcode_filename)
            
            # –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            self.open_document(self.current_template)
            
            messagebox.showinfo("–£—Å–ø–µ—Ö!", 
                              f"–®–∞–±–ª–æ–Ω —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!\n\n"
                              f"–§–∞–π–ª: {os.path.basename(self.current_template)}\n"
                              f"–ó–∞–º–µ–Ω–µ–Ω–æ –ø–æ–ª–µ–π: {replaced_count}/5\n"
                              f"–®—Ç—Ä–∏—Ö-–∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω: {'–î–∞' if image_replaced else '–ù–µ—Ç'}\n\n"
                              f"–§–∞–π–ª –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω –∏ –æ—Ç–∫—Ä—ã—Ç.")
            
        except Exception as e:
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:\n{str(e)}")
    
    def open_document(self, file_path):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
        try:
            if os.path.exists(file_path):
                if os.name == 'nt':  # Windows
                    os.startfile(file_path)
                elif os.name == 'posix':  # macOS, Linux
                    subprocess.run(['open', file_path] if os.name == 'posix' and os.uname().sysname == 'Darwin' else ['xdg-open', file_path])
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–∞–π–ª–∞: {e}")

if __name__ == "__main__":
    root = tk.Tk()
    app = PalletLabelEditor(root)
    root.mainloop()